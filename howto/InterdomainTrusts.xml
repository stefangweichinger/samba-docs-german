<?xml version="1.0" encoding="ISO-8859-1"?>
<chapter id="InterdomainTrusts">
<chapterinfo>
	&author.jht;
	&author.mimir;
	<author>&person.jelmer;<contrib>drawing</contrib></author>
        <author>
                <firstname>Stephen</firstname><surname>Langasek</surname>
                <affiliation>
                        <address><email>vorlon@netexpress.net</email></address>
                </affiliation>
        </author>
	<author>&person.flex;<contrib>Deutsche Übersetzung</contrib></author>
	<pubdate>April 3, 2003</pubdate>
</chapterinfo>

<title>Interdomain Vertrauensstellung</title>


<para>
<indexterm><primary>Interdomain Trusts</primary></indexterm>
Samba-3 unterstützt NT4-gleiche Domänen Vertrauensstellungen. Dies ist ein  Bestandteil den
viele Standorte benutzen möchten wenn sie von einer NT4-gleichen Domäne auf eine Samba-3 Domäne
migrieren, ohne Active Directory oder ein LDAP-basierendes Backend übernehmen zu müssen. Dieses Kapitel
beschreibt einige Hintergrundinformationen bezüglich Vertrauensstellungen und wie sie erstellt werden.
Es ist nun für Samba3 möglich NT4 zu vertrauen (und umgekehrt), genauso wie es möglich ist Samba-zu-Samba
Vertrauensstellungen zu erstellen.
</para>

<sect1>
<title>Eigenschaften und Vorzüge</title>

<para>
Samba-3 kann an einer Samba-zu-Samba Vertrauensstellung teilnehmen genauso wie in einer Samba
-zu-MS Windows NT4 Vertrauensstellung. Somit hat Samba eine ähnliche Skalierbarkeit wie
MS Windows NT4.
</para>

<para>
Gegeben das Samba-3 die Fähigkeit besitzt mit einem skalierbaren Authentifizierungsbackend
wie LDAP zu funktionieren, und gegeben dass es sowohl als Erster Domänen Kontroller sowie als
Backup Domänen Kontroller funktioniert, sollte der Administrator sich nach Alternativen umschauen,
bevor er Interdomänen Vertrauensstellung benutzt, aus dem einfachen Grund dass das Prinzip nach
dem sie arbeiten einfach unsicher ist. Dies war, unter anderem, ein Hauptgrund für die Entwicklung
von Microsoft Active Directory.
</para>

</sect1>

<sect1>
<title>Hintergrund von Vertrauensstellungen</title>

<para>
MS Windows NT3/4 Sicherheits Domänen haben eine nicht-hierarchische Sicherheits Struktur.
Die Einschränkungen dieser Architektur und wie sie die Skalierbarkeit von MS Windows
Netzwerken in grossen Organisationen betreffen, sind wohl bekannt. Dazu schränkt --the flat 
namespace-- der aus diesem Design hervorgeht auch die Verteilung von administrativen Aufgaben
in grossen Netzwerken sehr ein. 

#MS Windows NT3/4 type security domains employ a non-hierarchical security structure.
#The limitations of this architecture as it effects the scalability of MS Windows networking
#in large organizations is well known. Additionally, the flat namespace that results from
#this design significantly impacts the delegation of administrative responsibilities in
#large and diverse organizations.
</para>

<para>
Microsoft entwickelte Active Directory Service (ADS), basierend auf Kerberos und LDAP, als
ein Mittel die Einschränkungen der älteren Technologien zu umgehen. Nicht jede Organisation
ist gewillt oder bereit ADS einzusetzen. Für kleinere Unternehmen ist das alte NT4 Domänen 
Sicherheits Muster eher angebracht, es bleibt eine feste Benutzer Basis für welche es keinen
Grund gibt einen unterbrechenden Wechsel zu vollziehen um ADS zu adaptieren.
</para>

<para>
Mit MS Windows NT, hat Microsoft die Fähigkeit eingeführt, unterschiedlichen Sicherheits
Domänen einen Mechanismus zu erlauben so, dass Benutzern einer Domäne, Anmelderechte und Privilegien
in einer anderen Domäne gegeben werden können. Dies wird als <emphasis>Vertrauensstellung</emphasis>
(Trusts) beschrieben. Z.B. eine Domäne <emphasis>vertraut</emphasis> den Benutzern einer anderen Domäne.
Die Domäne, von welcher die Benutzer einer anderen Domäne zur Verfügung stehen, nennt man vertraute Domäne.
Die Domäne, in der diese Benutzer gewisse Rechte und Privilegien haben ist die vertrauende Domäne. Mit
NT3.x/4.0 gehen alle Vertrauensstellungen immer nur in eine Richtung, d.h. wenn Benutzer beider Domänen
in der jeweils anderen Domäne Rechte und Privilegien haben sollen, muss man zwei Vertrauensstellung aufbauen,
eine in jede Richtung.
</para>

<para>
In einer NT4-gleichen MS Sicherheits Domäne sind alle Vertrauensstellungen nicht-transitiv.
Das bedeutet, dass wenn wir drei Domänen haben (nennen wir sie ROT, WEISS und BLAU), in der ROT
und WEISS in einer Vertrauensstellung zueinander stehen, und WEISS und BLAU in einer Vertrauensstellung
stehen, dann bedeutet das nicht dass ROT und BLAU automatisch eine Vertrauensstellung zueinander haben.
Vertrauensstellung sind explizit und nicht transitiv. 
</para>

<para>
Neu im MS Windows 2000 ADS Sicherheits Kontext ist die Tatsache, dass Vertrauensstellungen durch
Voreinstellung in beiden Richtungen gehen. Zusätzlich sind alle inter-ADS Domänen Vertrauensstellung
transitive. Im Fall der ROT, WEISS und BLAU Domänen oben und Windows 2000 mit ADS, würde das bedeuten,
dass ROT und BLAU sich vertrauen würden. Dies ist eine Eigenschaft die nur ADS Domänen haben. Samba-3
implementiert MS Windows NT4-gleiche Domänen Vertrauensstellungen und verkehrt mit MS Windows 200x
ADS Sicherheits Domänen in einer ähnliche Weise wie mit MS Windows NT4-gleichen Domänen.
</para>

</sect1>

<sect1>
<title>Native MS Windows NT4 Vertrauenstellungen konfigurieren</title>

<para>
Es braucht 2 Schritte um eine interdomain Vertrauensstellung herzustellen. Um eine 2 Wege
Vertrauensstellung aufzubauen müssen beide Domänenadministratoren einen Trust Account für die
jeweils andere Domäne anlegen der dazu dient die Sicherheitsbeschränkungen zu überprüfen.
</para>


<sect2>
<title>Eine NT4 Vertrauensstellung aufbauen</title>

<para>
In MS Windows NT4 werden alle Domänen Vertrauensstellung mit dem<application>Domain User Manager</application>
konfiguriert. Dieser wird über den Domain User Manager Policies Eintrag in der Menüleiste erreicht. Vom
<guimenu>Policy</guimenu> Menü aus wählen Sie <guimenuitem>Trust Relationships</guimenuitem>. Gleich neben
der unteren Box mit dem Namen <guilabel>Permitted to Trust this Domain</guilabel> sind zwei Knöpfe, 
<guibutton>Add</guibutton> und <guibutton>Remove</guibutton>. Der <guibutton>Add</guibutton> Knopf öffnet 
ein Menü wo man den Namen der Domäne eintragen kann die dann befähigt ist Zugriffsrechte an Benutzer in
Ihrer Domäne zu vergeben. Sie müssen auch ein Passwort für diese Vertrauensstellung eingeben, welches
die vertrauende Domäne benötigt wenn sie Benutzer aus der vertrauten Domäne authentifiziert. Das Passwort
muss zweimal eingegeben werden (standard Bestätigung).
</para>

</sect2>


<sect2>
<title>Eine NT4 Vertrauensstellung fertigstellen</title>

<para>
<indexterm><primary>Interdomain Vertrauensstellungen</primary><secondary>Fertigstellen</secondary></indexterm>
Eine Vertrauensstellung funktioniert nur wenn die andere (vertrauende) Domäne die benötigten Verbindungen mit
der vertrauten Domäne herstellt. Um das Vertrauensverhältnis durchzuführen muss der Administrator den 
Domain User Manager starten, dann unter <guilabel>Policies</guilabel> den Menüpunkt <guilabel>Trust Relationships</guilabel>
auswählen, auf den <guibutton>Add</guibutton> Knopf klicken der neben sich der <guilabel>Trusted Domains</guilabel>
Box befindet. Es öffnet sich ein Menü in dem man den Namen der anderen Domäne sowie das Passwort zur Vertrauensstellung
eingeben muss.
</para>

</sect2>

<sect2>
<title>Inter-Domain Vertrauens Möglichkeiten</title>


<para>
<indexterm><primary>Interdomain Vertrauens</primary><secondary>Möglichkeiten</secondary></indexterm>
Eine zwei Wege Vertrauensstellung ist erstellt wenn zwei Ein-Weg Vertrauensstellungen erstell sind,
in jede Richtung eine. Wo eine Ein-Weg Vertrauensstellung zwischen zwei MS Windows NT4 Domänen besteht
(nennen wir sie DomA und DomB), wurden folgende Möglichkeiten hergestellt.
</para>

<image id="trusts1"><imagefile>Vertrauensstellungen1</imagefile><imagedescription>Vertrauens Überblick.</imagedescription></image>

<itemizedlist>
	<listitem><para>
	DomA (stellt die Vertrauensverbindung fertig) <parameter>vertraut</parameter> DomB.
	</para></listitem>

	<listitem><para>
	DomA ist die <parameter>vertrauende</parameter> Domäne.
	</para></listitem>

	<listitem><para>
	DomB ist die <parameter>vertraute</parameter> Domäne (originates the trust account).
	</para></listitem>

	<listitem><para>
	Benutzer aus DomB könne auf Ressourcen aus DomA zugreifen
	</para></listitem>

	<listitem><para>
	Benutzer aus DomA können nicht auf Ressourcen aus DomB zugreifen.
	</para></listitem>

	<listitem><para>
	Globale Grppen aus DomB können in DomA benutzt werden.
	</para></listitem>

	<listitem><para>
	Globale Gruppen aus DomA können nicht in DomB benutzt weden
	</para></listitem>

	<listitem><para>
	DomB erscheint im Logon Dialog auf client Workstations von DomA.
	</para></listitem>

	<listitem><para>
	DomA erscheint nicht im Logon Dialog auf client Workstations von DomB.
	</para></listitem>
</itemizedlist>

<itemizedlist>
	<listitem><para>
	Benutzer/Gruppen in einer vertrauenden Domäne können keine Zugriffe oder Rechte
	zu einer vertrauten Domäne gegeben werden.
	</para></listitem>

	<listitem><para>
	Die vertrauende Domäne kann auf Konten (Benutzer/Globale Gruppen) der 
	vertrauten Domäne zugreifen und sie benutzen.
	</para></listitem>

	<listitem><para>
	Administratoren der vertrauten Domäne können administrative Rechte in der vertrauenden Domäne
	gegeben werden.
	</para></listitem>

	<listitem><para>
	Benutzer in einer vertrauten Domäne können Rechte und Privilegien in der vertrauenden Domäne gegeben
	werden.
	</para></listitem>

	<listitem><para>
	Globale Gruppen der vertrauten Domäne können Rechte und Zugriffe in der vertrauenden Domäne
	gegeben werden.
	</para></listitem>

	<listitem><para>
	Globale Gruppen einer vertrauten Domäne können Mitglieder in Lokalen Gruppen
	einer MS Windows Domain Member Maschine werden.
	</para></listitem>
</itemizedlist>

</sect2>

</sect1>

<sect1>
<title>Konfigurieren einer Samba NT-gleichen Vertrauensstellung</title>

<para>
Diese Beschreibung sollte eine recht kurze Einführung sein wie man einen Samba Server aufsetzt so
dass er an einer Inderdomain Vertrauensstellung Teilnehmen kann. Die Unterstützung von Verstrauensstellungen
in Samba ist in einem frühen Stadium, deshalb sollte man nicht überrascht sein wenn etwas nicht funktioniert
wie es sollte.
</para>

<para>
Alle unten beschriebenen Szenarien gehen davon aus dass die Peer Domäne in der Vertrauensstellung von
einem Windows NT4 Server betrieben wird. Das entfernte Ende könnte aber auch genausogut eine andere
Samba-3 Domäne sein. Nachdem man dieses Dokument zu ende gelesen hat, kann man gut erkennen dass wenn
man Samba-spezifische Teile von den unten beschrieben zusammensetzt, auch eine Vertrauensstellung zwischen
Domänen in einer reinen Samba Umgebung herstellen kann.
</para>

<sect2 id="samba-trusted-domain">
<title>Samba als vertraute Domäne</title>

<para>
Um den Samba PDC als vertraute Seite der Vertrauensstellung festzulegen muss zuerst ein spezielles
Konto in der Domäne festgelegt werden die die vertrauende Seite sein wird. Um dies zu machen kann
das <command>smbpasswd</command> Programm verwendet werden. Ein vertrautes Domänen Konto zu erstellen
funktioniert ähnlich wie ein vertrautes Maschinen Konto zu erstellen. Angenommen, Ihre Domäne heisst
SAMBA, und die entfernte Domäne ist RUMBA. Der erste Schritt ist, folgenden Befehl in Ihrer lieblings 
Shell auszuführen:
</para>

<para>
<screen>
&rootprompt; <userinput>smbpasswd -a -i rumba</userinput>
New SMB password: <userinput>XXXXXXXX</userinput>
Retype SMB password: <userinput>XXXXXXXX</userinput>
Added user rumba$
</screen>

wobei <option>-a</option> bedeutet dass ein neues Konto der passdb Datenbank hinzugefügt wird
und <option>-i</option> soviel heisst wie <quote>erstelle dieses Konto mit der Inter-Domain
vertrauens flag</quote>.
</para>

<para>
Der Konto Namen ist nun <quote>rumba$</quote> (der Namen der entfernten Domäne)
Falls dies fehlschlägt sollten Sie überprüfen ob das Konto der System Password
Datenbank (<filename>/etc/passwd</filename>) hinzugefügt wurde. Falls nicht, können
sie es händisch hinzufügen und dann obigen Schritt wiederholen.
</para>

<para>
Nachdem sie diesen Befehl eingegeben haben, werden Sie nach einem Password für dieses Konto gefragt.
Sie können hier jedes beliebige Passwort verwenden, aber beachten Sie dass Windows NT dieses Passwort
nicht vor 7 Tage nach der Konto Erstellung ändern wird. Nach erfolgreicher Ausführung des Befehls,
können sie den Eintrag für das neue Konto anschauen (in der Art wie es Ihre Konfiguration vorsieht),
und Sie werden sehen dass der Kontoname wirklick RUMBA$ ist und dass die <quote>I</quote> flag im flags Feld
gesetzt ist. Sie sind nun bereit die Vertrauensstellung zu bestätigen, indem Sie sie vom Windows NT Server
aus aufbauen.
</para>


<para>
<indexterm><primary>User Manager</primary></indexterm>
Öffnen Sie den <application>User Manager for Domains</application> und vom
<guimenu>Policies</guimenu> Menu, wählen Sie <guimenuitem>Trust Relationships...</guimenuitem>.
Neben der <guilabel>Trusted domains</guilabel> List Box klicken Sie den
<guimenu>Add...</guimenu> Knopf. Sie werden nach dem Namen der vertrauten Domäne und dem
dazugehörigen Passwort gefragt. Geben Sie SAMBA an, da dies der Name unserer entfernten Domäne ist,
und das Passwort welches bei der Konto Erstellung verwendet wurde. Klicken Sie auf den <guibutton>OK</guibutton>
und, wenn alles ohne Fehler ging, werden Sie die <computeroutput>Trusted domain relationship successfully 
established</computeroutput> Mitteilung bekommen.
</para>

</sect2>
<sect2>
<title>Samba als die vertrauende Domäne</title>

<para>
Jetzt werden die Aufgaben umgekehrt. Wieder nehmen wir an, dass Ihre vom Samba PDC kontrollierte Domäne
SAMBA heisst und die NT-kontrollierte Domäne RUMBA.
</para>

<para>
Der erste Schritt ist ein Konto für die SAMBA Domäne auf dem RUMBA PDC zu erstellen.
</para>


<para>
<indexterm><primary>User Manager</primary></indexterm>
Starten Sie den <application>Domain User Manager</application>, wählen sie vom Menü
<guimenu>Policies</guimenu>, <guimenuitem>Trust Relationships</guimenuitem> aus. Jetzt
drücken Sie den <guibutton>Add</guibutton> Knopf der sich neben der <guilabel>Trusted Domains</guilabel>
Box befindet und geben den Namen der vertrauten Domäne (SAMBA) und das Passwort für die Sicherung der 
Vertrauensstellung ein.
</para>

<para>
Das Passwort kann willkürlich gewählt werden. Es ist einfach das Passwort zu jedem Zeitpunkt vom Samba
Server aus zu ändern. Nachdem man das Passwort bestätigt hat ist das Konto fertig für den Gebrauch. Jetzt
ist der Samba Server an der Reihe.
</para>

<para>
Als root mit ihrer bevorzugten Shell angemeldet, führen Sie diesen Befhel aus:
</para>

<para>
&rootprompt;<userinput>net rpc trustdom establish rumba</userinput>
</para>

<para>
Sie werden nach dem Password gefragt das Sie gerade in Ihrer Windows NT4 Server Maschine
eingegeben haben. Die Fehlermeldung <errorname>`NT_STATUS_NOLOGON_INTERDOMAIN_TRUST_ACCOUNT'</errorname>,
welche manchmal auftritt, kann getrost ignoriert werden. Sie bedeutet dass das Passwort das Sie eingegeben
haben richtig ist und der NT4 Server zurückgibt, dass das Konto bereit für eine Interdomain Verbindung ist und nicht
für eine Normale Verbindung. Nach dieser Prozedur müssen Sie etwas gedulding sein, es könnte eine Weile
dauern (vor allem in grossen Netzwerken), aber schließlich sollten Sie die <computeroutput>Success</computeroutput>
Meldung sehen. Gratulation! Ihre Vertrauensstellung wurde in diesem Moment fertig gestellt.
</para>

<note><para>
Sie müssen diesen Befehl als root ausführen da sie Schreibrechte auf die Datei
<filename>secrets.tdb</filename> haben müssen.
</para></note>

</sect2>
</sect1>

<sect1>
<title>NT4-gleiche Domänen Vertrauensstellungen mit Windows 2000</title>
<para>
Obwohl der <application>Domain User Manager</application> unter Windows 2000 nicht mehr existiert,
ist es trotzdem möglich eine NT4-gleiche Vertrauensstellung mit einem Windows 2000 Domänenkontroller,
der im gemischten Modus als vertrauender Server läuft, aufzubauen. Es sollte auch für Samba möglich sein
einem Windows 2000 Server zu vertrauen, in diesem Gebiet muss jedoch noch getestet werden.
</para>

<para>
Nach Fertigstellung des <link linkend="samba-trusted-domain">erstellen eines interdomain Vertrauens Konto
auf dem Samba Server</link> wie oben beschrieben, öffnen Sie <application>Active Directory Domains and 
Trusts</application> auf dem AD Kontroller der Domäne deren Ressourcen sie den Samba Benutzern zur Verfügung
stellen möchten. Wenn Sie möchten dass Ihre Benutzer Zugriff auf mehrer mixed-Mode Domänen in Ihrem AD Forest haben,
müssen Sie diesen Vorgang für alle Domänen wiederholen. Nachdem Sie <application>Active Directory Domains and 
Trusts</application> geöffnet haben, machen Sie einen Rechtsklick auf die Domäne die unserer Samba Domäne vertrauen
soll und wählen <guimenuitem>Properties</guimenuitem>, dann klicken sie auf den <guilabel>Trusts</guilabel> tab.
Im oberen Teil der Leiste sehen Sie eine List Box mit dem Namen <guilabel>Domains trusted by this domain:</guilabel>,
und einen<guilabel>Add...</guilabel> Knopf daneben. Drücken Sie diesen Knopf und gleich wie bei NT4, werden Sie nun
nach der Domäne und dem Passwort für die Vertrauensstelung gefragt. Drücken Sie OK, und nach einem Moment wird Active 
Directory mit einer <computeroutput>The trusted domain has been added and the trust has been verified.</computeroutput>
Meldung antworten. Ihren Samba Benutzern kann nun Zugriff zu den Resourcen in der AD Domäne gegeben werden.
</para>
</sect1>

<sect1>
<title>Häufige Fehler</title>

<para>
Interdomain Vertrauensstellungen sollten nicht in Netzwerken erstellt werden die instabil
sind oder öfters Ausfälle haben. Netzwerkstabilität und -integrität sind Schlüsselvoraussetzungen
für verteilte vertraute Domänen.
</para>

<sect2>
<title>Durchsuchen der vertrauten Domäne schlägt fehl</title>

<para>
Während des Durchsuchens eines Windows 200x Mitglieds einer vertrauten Samba Domäne, von einer
Maschine aus einer vertrauten Domäne, bekomme ich folgenden Fehler:
</para>

<formalpara><emphasis>
Das System hat einen möglichen Angriff auf die Sicherheit festgestellt. Bitte versichern
Sie sich, dass Sie Kontakt zu dem Server haben der Sie authentifiziert.
</emphasis>
</formalpara>

<para>
Die Event Logs auf der Maschine die ich versuche zu erreichen, haben Einträge die
nicht angewendete Gruppen Richtlinien betreffen, weil diese Maschine ein Mitglied 
einer untergeordneten Domäne ist.
</para>

<para><emphasis>Antwort: </emphasis> 
Falls ein Computer Konto für die betroffen Maschine in der Windows 200x Domäne existiert,
und diese deaktiviert ist, kann dieses Problem auftreten. Falls dieses Computer Konto nicht
existiert (entfernt oder nie erstellt), oder dieses Konto noch immer intakt ist (z.B.:
Sie haben es gerade in eine andere Domäne verschoben) sollte alles in Ordnung sein.
Normalerweise, wenn man die Domäne (die Windows 200x Domäne) verlässt, versucht der Computer
automatisch das Computer Konto zu deaktivieren. Falls, während dieses Vorgangs, ein Konto verwendet
wird welches die Privilegien dazu hat, wird es erledigt, sonst nicht.
</para>

</sect2>

<sect2>
<title>Probleme mit LDAB ldapsam und den smbldap-tools</title>

<para>
Wenn Sie das <command>smbldap-useradd.pl</command> Skript benützen, um ein
Konto, für die Fertigstellung einer interdomain Vertrauensstellung, zu erstellen wird
dieser Prozess fehlschlagen. Das Konto welches in der LDAP Datenbank erstellt wurde
wird ein Konto Flags Feld haben das <constant>[W          ]</constant> enthält, wärend
es <constant>[I          ]</constant> für eine funktionierende Interdomain Vertrauensstellung
enthalten müsste.
</para>

<para><emphasis>Antwort: </emphasis>Hier eine einfache Lösung.
Erstellen Sie ein Maschinen Konto wie folgt:
<screen>
&rootprompt; smbldap-useradd.pl -w domain_name
</screen>
Dann setzen Sie gewünschte Vertrauensstellungs Konto Passwort wie hier:
<screen>
&rootprompt; smbldap-passwd.pl domain_name\$
</screen>
Mit einem Text Editor erstellen sie folgenden Datei:
<screen>
dn: uid=domain_name$,ou=People,dc={your-domain},dc={your-top-level-domain}
changetype: modify
sambaAcctFlags: [I         ]
</screen>
Dann fügen Sie die Txt Datei wie folgt der LDAP Datenbank hinzu:
<screen>
&rootprompt; ldapmodify -x -h localhost \
 -D "cn=Manager,dc={your-domain},dc={your-top-level-domain}" \
 -W -f /path-to/foobar
</screen>
Erstellen Sie eine einseitige Vertrauensstellung mit dem NT4 Domain User Manager, dann führen Sie folgedes aus:
<screen>
&rootprompt; net rpc trustdom establish domain_name
</screen>
</para>

<para>
Dies funktioniert mit Samba-3 und NT4 Domänen, sowie mit Samba-3 und Windows 200x ADS in gemischtem Mode.
Beide DC's, Samba und NT, müssen den gleichen WINS Server benutzen, sonst wird die Vertrauensstellung nie funktionieren.
</para>

</sect2>

</sect1>

</chapter>
